# Gunpuppy
# Simple turret enemy
# TODO: (This only includes things which may not be obvious)
#	Make it fling the player off if it's stood on for too long

{
#GLOBAL VALUES#

id: "gunpup_norm",
prototype: ["hittable"],
editor_info: { category: "Monsters, Construct" },
solid_dimensions: ["common","enemy"],
hitpoints: 200,
max_hitpoints: 200,

properties: {
	desired_facing: "int :: if(level.player.midpoint_x < self.midpoint_x, -1, 1)",

	choose_action: "def() -> commands
					if(player_noticeable, animation('direction_check'), animation('stand'))",
	
	player_noticeable: "int :: if(player_in_decent_y_pos and abs(level.player.midpoint_x - self.midpoint_x) < if(self.facing = desired_facing, front_detection_area, rear_detection_area), 1, 0)",
	
	rear_detection_area: "int :: if(higher_difficulty, 500, 150)",
	front_detection_area: "int :: if(higher_difficulty, 500, 400)",
	
player_in_decent_y_pos: "bool :: if(stair_shot_worth_taking, true, (level.player.midpoint_y > self.y-player_x_dist and level.player.midpoint_y < self.y2 and abs(slope_standing_on) < 1))",
	player_x_dist: "decimal :: abs(level.player.mid_x - self.mid_x)/4",
	
	attack_countdown_length: "int|bool :: if(higher_difficulty, 1, 3)",
	
	prepare_to_fire: "def() -> commands
					animation('open')",
	
	
	stair_shot_worth_taking: "bool :: (slope_standing_on != 0 and player_on_stairs)  where player_on_stairs = (5 > abs(slope_standing_on - (lib.math.angle(me,level.player)+180*if(facing<0,1,0))))",
},

#ANIMATION HANDLES#
on_end_stand_anim: "choose_action()",
on_end_direction_check_anim: "if(facing != desired_facing,
	    animation('turn'), prepare_to_fire())",

on_process_turn: "if(time_in_animation = 8, set(facing, desired_facing))",

on_end_turn_anim: "choose_action()",
on_end_open_anim: "animation('fire')",
on_end_fire_anim: "animation('close')",
on_end_close_anim: "choose_action()",

on_shoot: "[spawn('gunpup_norm.gunpup_bullet', midpoint_x+ facing*5, midpoint_y - 13, facing,
		[set(child.velocity_x, 750 * facing),
		set(child.velocity_y, 1200 * sin(slope_standing_on) * facing +1d150-100)]),
		spawn('kitty_gun.muzzle_flash', midpoint_x+ facing*50, midpoint_y -2, facing),sound_falloff('cannon.ogg')]",

#ANIMATIONS#
animation: [
	{
		id: "stand",
		body_area: "all",
		image: "construct/gunpup_norm.png",
		rect: [5,7,28,33],
		solid_area: [5,3,18,25],
		pad: 4,
		frames: 3,
		frames_per_row: 3,
		accel_x: 0,
		accel_y: 100
	},
	{
	# This animation is ran right after noticing the player. It triggers 'turn'
		id: "direction_check",
		body_area: "all",
		image: "construct/gunpup_norm.png",
		rect: [5,7,28,33],
		solid_area: [5,3,18,25],
		pad: 4,
		frames: 3,
		frames_per_row: 3,
		accel_x: 0,
		accel_y: 100
	},
	{
		id: "turn",
		body_area: "all",
		image: "construct/gunpup_norm.png",
		rect: [5,7,28,33],
		solid_area: [5,3,18,25],
		pad: 4,
		frames: 3,
		frames_per_row: 3,
		duration: 3,
		reverse: true,
		accel_x: 0,
		accel_y: 100
	},
	{
		id: "open",
		body_area: "all",
		image: "construct/gunpup_norm.png",
		rect: [5,42,28,72],
		solid_area: [4,5,17,29],
		pad: 4,
		frames: 3,
		frames_per_row: 3,
		duration: 4,
		accel_x: 0,
		accel_y: 100
	},
	{
		id: "fire",
		body_area: "all",
		events: "1:shoot",
		image: "construct/gunpup_norm.png",
		rect: [5,77,28,107],
		solid_area: [4,5,17,29],
		pad: 4,
		frames: 1,
		frames_per_row: 3,
		duration:50,
		accel_x: 0,
		accel_y: 100
	},
	{
		id: "close",
		body_area: "all",
		image: "construct/gunpup_norm.png",
		rect: [5,112,28,142],
		solid_area: [4,5,17,29],
		pad: 4,
		frames: 3,
		frames_per_row: 3,
		duration: 4,
		accel_x: 0,
		accel_y: 100
	},
	{
		id: "shake",
		body_area: "all",
		image: "construct/gunpup_norm.png",
		rect: [5,7,26,37],
		solid_area: [3,5,16,29],
		pad: 4,
		frames: 2,
		frames_per_row: 2,
		accel_x: 0,
		accel_y: 100
	}
],

# Bullets and effects
object_type: [
		{
		id: "gunpup_bullet",
		dies_on_inactive: true,
		timer_frequency: 450,
		object_level_collisions: true,
		solid_dimensions: ["player"],
		prototype: ["shot"],
		properties: {
		#	attack_damage: "if(level.player.difficulty <= level.player.difficulty_casual,1,2)",
			attack_damage: "1",
		},
		
		on_end_normal_anim: "animation('normal')",
		on_process: "if((time_in_animation%7) = 0, spawn('gunpup_norm.gunpup_bullet_trail',midpoint_x,midpoint_y,{velocity_x:0,velocity_y:0}))",
		on_end_flash_anim: "die()",
		on_timer: "die()",
		
		animation: 
			{
				id: "normal",
				image: "construct/gunpup_norm.png",
				attack_area: [0,0,11,11],
				pad: 3,
				rect: [6,148,22,164],
				frames: 5,
				frames_per_row: 2,
				duration: 4
			},
		},
			
		{
		id: "gunpup_bullet_trail",
		ignore_collide: true,
		on_end_normal_anim: "die()",
		zorder: 50,
		dies_on_inactive: true,
		on_spawned: "animation('normal')",
		
		animation: 
			{
				id: "normal",
				image: "construct/gunpup_norm.png",
				pad: 3,
				rect: [6, 208, 10, 212],
				frames: 5,
				frames_per_row: 5,
				duration: 4,
				x_accel: 0,
				y_accel: 0
			},
		}
],

}
