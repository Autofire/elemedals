# Pivot
# Main player.
# TODO:
# Give Pivot a turn animation (Will not interfere with other actions)
# Fix flinch-during-jump
# Fix damage hitboxes while running
# Fix second sword swing animation

{
is_strict: true,

id: "pivot_playable",
prototype: [
	"pivot_input_keyboard",
	"pivot_properties_sword",	// NOTE: This order must be maintained
	"player_controlled_platformer_character",
	"pivot_anim_general",
	"pivot_anim_sword",
],

editor_info: { category: "player" },
solid_dimensions: ["player","common","boss"],
collide_dimensions: ["common","enemy","boss","hazard"],
vehicle: false,
hitpoints: 30,
mass: 5,
is_human: true,
friction: 2200,
traction_in_air: 100,
traction_in_water: 1000,
feet_width: 5,
zorder: "@include data/zorder.cfg:player",

properties: {
	///////////////
	// VARIABLES //
	///////////////
	airSpeed:   { type: "int", default: 30 },

	jumpTicks: { type: "int", init: 0 },
	jumpPower: { type: "int", init: 1800 },
	 
	cycleOfLastUp: 	{ type: "int", default: 0 },	
	cycleOfLastSwordInput: { type: "int", default: 0 },

	// Equipment -- These will change often throughout the game
	sword: { type: "string", default: 'calibur' },


	///////////////
	// CONSTANTS //
	///////////////
	cTEAM: "'player'",
	cLEFT: -1,
	cRIGHT: 1,
	
	cBASE_RUN_SPEED: "int :: 190",
	
	cFLINCH_THRESHOLD: 0,
	cHURT_VELOCITY_Y: "-1100",
	cHURT_VELOCITY_X: "250",
	
	cATTACK_DAMAGE: "5",
	cDAMAGE_COOLDOWN: "-1",
	
	cSOONEST_SWORD_REQUEST: "10",	// The earliest the player can be when
									  // attempting to swing their sword. This
									  // will probably vary based on sword.
	
	// Overloaded from hittable.cfg
	cMINOR_ATTACK_NUM: "if(cANIM_NUM = null, 1, cANIM_NUM)",

	cCAN_TURN: "bool :: bool(cANIM_GROUP != sword)",
	
	

	///////////////
	// FUNCTIONS //
	///////////////
	
	// HUD //
	guiHeartDisplay: {
		type: "obj heart_display",
		init: "object('heart_display', 27+0, 27+0, 1)",
		persistent: false,
	},
	
	SetUpGui: "def() -> commands 
		map(components,
			'gui_element', [
				remove_object(gui_element),
				add_object(gui_element),
			]
		) where components = [guiHeartDisplay]
	",


    
	/******************************************************
	 * CharToInt
	 *  This function accepts a single character, and then
	 * converts it to an integer. If it isn't a valid
	 * number, it returns 0.
	 ******************************************************/
	CharToInt: "def(string inStr) -> int
		if(inStr in numbers, int(inStr), 0)
			where numbers = ['1','2','3','4','5','6','7','8','9','0']
	",
	
	/******************************************************
	 * FilterNull
	 *  This function accepts an integer or a null. If
	 * given a null, it returns an empty string. Otherwise,
	 * it returns the integer.
	 ******************************************************/
	FilterNull: "def(int|null num) -> int|string
		if(num = null, '', num)
	",
	
	/******************************************************
	 * TryTurn
	 *  Given a direction, this function will attempt to
	 * set the facing to the new one, based on cCAN_TURN.
	 ******************************************************/
	TryTurn: "def(int newdir) -> commands
		if(cCAN_TURN, set(facing, newdir))",
	
	// Overloading (from hittable) because we want to flinch in air
	HandleFlinch: "def(obj hittable collide_with) -> commands
		execute(me,
			if(final_damage_amount(collide_with,
								   collide_with.cATTACK_DAMAGE) >= cFLINCH_THRESHOLD,
				cause_flinch(collide_with))
	)",
	

},

#ANIMATION HANDLES#
on_create: "[animation('stand'), SetUpGui(), set(jumpTicks, 0) ]",
on_collide_feet: "if(animation not in ['calibur1','hurt'], animation('stand'))",

# -- stuff that is related to the player's input follows
on_process: "[
	fire_event('bookkeep'),
	
//	debug(time_in_animation),
	//debug(CtrlKeyboard(keyBindings['sword'])),
	debug(CtrlReleased('sword')),
	
	// INPUT //
	map(values(keyBindings), value, TrackKey(value)),
	
	if(CtrlPressed('sword'),
		fire_event('ctrl_sword')
	),
	
	if((ctrl_left or ctrl_right) and (animation = 'stand'),
		set(animation, 'run')
	),
		
	if(ctrl_left  and cIN_CONTROLLABLE_ANIM, [
		TryTurn(cLEFT),
		if(is_standing, add(velocity_x, -cRUN_SPEED), add(velocity_x, -airSpeed))]),
					
	if(ctrl_right and cIN_CONTROLLABLE_ANIM, [
		TryTurn(cRIGHT),
		if(is_standing, add(velocity_x, cRUN_SPEED), add(velocity_x, airSpeed))]),
]",

on_process_stand: "if(
	not is_standing,
		animation('beginFall')
)",			
on_process_run: "if(
	not (ctrl_left or ctrl_right),
		animation('stand'),
	not is_standing,
		animation('beginFall')
)",
on_end_stand_anim: "animation('stand')",
on_end_run_anim:   "animation('run')",
on_end_hurt_anim:  "animation('beginFall')",

# -- Jumping and falling -- #
on_ctrl_jump: "if(is_standing and cIN_GROUNDED_ANIM,
				[animation('jump'), add(velocity_y, -jumpPower)]
				)",
				
on_process_jump: "if(not ctrl_jump, [
				if(velocity_y < 0, set(velocity_y, -200)),
				animation('beginFall')],
				
				velocity_y >= 0, animation('beginFall'),
				
				add(velocity_y, -20)
				)",
				
on_end_beginFall_anim: "[animation('fall')]",

on_end_anim: "[
	if(cANIM_GROUP = sword, fire_event('end_sword_anim')),
]",

/////////////////////
// ATTACK HANDLING //
/////////////////////

on_ctrl_attack: "spawn('bomb_blast', 30, 0, facing)",


on_enter_hurt_anim: "debug(['HP: ',hitpoints - 1])",


on_ctrl_up: "if(cycleOfLastUp + 20 < cycle,
			set(cycleOfLastUp, cycle),
			speech_dialog(level.player,
		[~Thanks for downloading this demo!
		  There are a few things that need to be said.~],
		[~First off, this game is inspired by Spiral Knights,
		  and it will always be completely free.~],
		[~This tileset came from Frogatto. The Frogatto
		  cTEAM gave permission to use it for now.~],
		[~Lastly, this is a very early version.
		  Things will change radically in the future!~],
		))",
}
